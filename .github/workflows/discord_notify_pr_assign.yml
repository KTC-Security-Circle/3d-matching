name: Discord Notify PR Assignee

on:
  pull_request_target:
    types: [assigned]

permissions:
  contents: read

jobs:
  handle-assign:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Send Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_NOTIFY_URL }}
          ID_MAP: ${{ secrets.DISCORD_USER_ID_AND_GITHUB_USERS }}
        run: |
          GITHUB_USER="${{ github.event.assinee.login }}"

          echo "GITHUB_USER = $GITHUB_USER"

          # GitHub ユーザー名 -> Discord ID にマッピング
          VALUE=$(echo "$ID_MAP" | jq -r --arg key "$GITHUB_USER" '.[$key]')

          echo "Parsed value: $VALUE"

          # Discord メンション用テキスト
          if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
            CONTENT="この Pull Request をレビューしてください。（Discord ID 未設定: $GITHUB_USER）"
          else
            CONTENT="<@!${VALUE}> この Pull Request にアサインされました。"
          fi
      
          echo "CONTENT = $CONTENT"
      
          # GitHub から PR のタイトルやURLなどを取得
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
      
          echo "PR_TITLE  = $PR_TITLE"
          echo "PR_NUMBER = $PR_NUMBER"
          echo "PR_URL    = $PR_URL"
      
          # Discord embed用のタイトル（#番号: タイトル）
          EMBED_TITLE="#${PR_NUMBER}: ${PR_TITLE}"
      
          # Discord embedの色（10進数の整数）。ここでは青系 (0x3498db) を使用
          EMBED_COLOR=3447003
      
          # jq で JSON を組み立て（手書きより安全）
          PAYLOAD=$(jq -n \
            --arg content "$CONTENT" \
            --arg title "$EMBED_TITLE" \
            --arg url "$PR_URL" \
            --arg desc "Pull Request へのリンク: $PR_URL" \
            --argjson color "$EMBED_COLOR" \
            '{
              content: $content,
              allowed_mentions: {
                parse: ["users"],
                replied_user: true
              },
              embeds: [
                {
                  title: $title,
                  url: $url,
                  description: $desc,
                  color: $color
                }
              ]
            }'
          )

          echo "Sending payload: $PAYLOAD"

          curl -s -H "Content-Type: application/json" \
           -X POST \
           -d "$PAYLOAD" \
           "$WEBHOOK_URL"
